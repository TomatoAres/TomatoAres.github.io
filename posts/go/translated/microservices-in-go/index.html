<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>Go 语言中的微服务 | 西红柿的博客</title>
    <meta property="og:title" content="Go 语言中的微服务 - 西红柿的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2019-08-14T23:04:12&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2019-08-14T23:04:12&#43;08:00'>
        
    <meta name="Keywords" content="golang,go语言,go语言笔记,kubernetes,network">
    <meta name="description" content="Go 语言中的微服务">
        
    <meta name="author" content="战神西红柿">
    <meta property="og:url" content="https://tomatoares.github.io/posts/go/translated/microservices-in-go/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://tomatoares.github.io">
                        西红柿的博客
                    </a>
                
                <p class="description">专注于IT互联网, 包括但不限于Go语言(golang)、云计算、kubernetes、IAAS/PAAS</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://tomatoares.github.io">首页</a>
                    
                    <a  href="https://tomatoares.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://tomatoares.github.io/posts/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#摘要">摘要</a></li>
    <li><a href="#框架简介">框架简介</a>
      <ul>
        <li><a href="#go-micro">Go Micro</a></li>
        <li><a href="#go-kit">Go Kit</a></li>
        <li><a href="#gizmo">Gizmo</a></li>
        <li><a href="#kite">Kite</a></li>
      </ul>
    </li>
    <li><a href="#比较框架">比较框架</a>
      <ul>
        <li><a href="#github-统计">GitHub 统计</a></li>
        <li><a href="#文档和示例">文档和示例</a></li>
        <li><a href="#用户和社区">用户和社区</a></li>
        <li><a href="#代码质量">代码质量</a></li>
      </ul>
    </li>
    <li><a href="#微服务代码实践">微服务代码实践</a>
      <ul>
        <li><a href="#go-micro-greeter">Go Micro greeter</a></li>
        <li><a href="#go-kit-greeter">Go Kit greeter</a></li>
        <li><a href="#gizmo-greeter">Gizmo greeter</a></li>
      </ul>
    </li>
    <li><a href="#结论">结论</a></li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if (leftPos < 220) {
                postToc.css({ "width": leftPos - 10, "margin-left": (0 - leftPos) })
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }

        if ($("#TableOfContents").children().length < 1) {
            $(".post-toc").remove();
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">Go 语言中的微服务</h1>
        </header>
        <date class="post-meta meta-date">
            2019年8月14日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/GCTT'>GCTT</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h2 id="摘要">摘要</h2>
<p>我最近在墨尔本 Golang 聚会上就如何开发微服务和框架做了一次演讲。在本文中，我将与您分享我的想法（此外，它对我来说是一个很好的复习）。</p>
<p>在这里，我要介绍以下框架：</p>
<ul>
<li><a href="https://micro.mu/">Go Micro</a></li>
<li><a href="https://gokit.io/">Go Kit</a></li>
<li><a href="https://github.com/NYTimes/gizmo">Gizmo</a></li>
<li><a href="https://github.com/koding/kite">Kite</a></li>
</ul>
<h2 id="框架简介">框架简介</h2>
<h3 id="go-micro">Go Micro</h3>
<p>这是我认为最受欢迎的框架之一。有很多博客文章和简单的例子可供使用参考。您可以从 <a href="https://medium.com/microhq">microhq</a> 在 Medium 或 <a href="https://twitter.com/MicroHQ">@MicroHQ</a> 获得 Go Micro 的最新更新。</p>
<p>那么，什么是 Go Micro ?</p>
<p>它是一个可拔插的 RPC 框架，用于在 Go 中编写微服务。开箱即用，您将看到：</p>
<ul>
<li>服务发现 - 自动向服务发现系统注册的应用程序。</li>
<li>负载均衡 - 客户端负载均衡，用于平衡服务实例之间请求的负载。</li>
<li>同步通信 - 提供请求/响应传输层。</li>
<li>异步通信 - 内置发布/订阅功能。</li>
<li>消息编码 - 基于消息的 Content-Type 请求头的编码/解码。</li>
<li>RPC 客户端/服务器打包 - 利用上述特性并公开接口来构建微服务。</li>
</ul>
<p>Go Micro 架构可以描述为三层堆栈。</p>
<p>
        <img class="mx-auto" alt="图 1.Go Micro 架构" src="https://raw.githubusercontent.com/studygolang/gctt-images/master/microservices-in-go/goMicro.png" />   
    </p>
<p>顶层包括 <strong>Server-Client</strong> 模型和服务抽象。该服务器是用于编写服务的基础。而客户端提供了一个接口，用于向服务端发起请求。</p>
<p>底层包含以下类型的插件：</p>
<ul>
<li>Broker - 提供一个消息代理接口，用于<strong>异步发布/订阅通信</strong>。</li>
<li>Codec - 用于编码/解码消息。支持的格式包括 json,bson,protobuf,msgpack 等。</li>
<li>Registry - 提供服务发现机制（默认为 Consul ）。</li>
<li>Selector - 基于注册表构建的负载均衡抽象。
它允许使用诸如 random,roundrobin,leastconn 等算法“选择”服务。</li>
<li>Transport - 服务之间同步请求/响应通信的接口。</li>
</ul>
<p>Go Micro 还提供 Sidecar 等功能。这允许您使用 Go 以外的语言编写的服务。
Sidecar 提供服务注册，gRPC 编码/解码和 HTTP 处理程序。它有多种语言版本。</p>
<h3 id="go-kit">Go Kit</h3>
<p>Go Kit 是一个用于在 Go 中构建微服务的编程工具包。与 Go Micro 不同，它是一个旨在导入二进制包的库。</p>
<p>Go Kit 遵循简单的规则，例如：</p>
<ul>
<li>没有全局状态</li>
<li>声明性构造</li>
<li>显式依赖</li>
<li>接口作为契约</li>
<li>领域驱动设计</li>
</ul>
<p>在 Go Kit 中，您可以找到以下包：</p>
<ul>
<li>身份验证 - basic 和 JWT。</li>
<li>传输 - HTTP，Nats，gRPC 等。</li>
<li>日志记录 - 服务中结构化日志记录的通用接口。</li>
<li>软件度量 - CloudWatch,Statsd,Graphite 等。</li>
<li>追踪 - Zipkin 和 Opentracing。</li>
<li>服务发现 - Consul,Etcd,Eureka 等。</li>
<li>熔断器 - Hystrix 的 Go 语言实现。</li>
</ul>
<p>您可以在 Peter Bourgon 的文章和演示幻灯片中找到 Go Kit 的最佳描述之一：</p>
<ul>
<li><a href="https://peter.bourgon.org/go-kit/?source=post_page">Go kit: Go in the modern enterprise</a></li>
<li><a href="https://github.com/peterbourgon/go-microservices?source=post_page">Go + microservices</a></li>
</ul>
<p>此外，在“Go + microservices”幻灯片中，您将找到使用 Go Kit 构建的服务架构的示例。
有关快速参考，请参阅服务架构图。</p>
<p>
        <img class="mx-auto" alt="图 2. 使用 Go Kit 构建的服务架构示例 Go Micro 架构" src="https://raw.githubusercontent.com/studygolang/gctt-images/master/microservices-in-go/Go%2Bmicroservices.png" />   
    </p>
<h3 id="gizmo">Gizmo</h3>
<p>Gizmo 是纽约时报的微服务工具包。它提供了将服务器和 pubsub 守护进程组合在一起的软件包。它公开了以下包：</p>
<ul>
<li><a href="https://godoc.org/github.com/NYTimes/gizmo/server">server</a> - 提供两种服务器实现：SimpleServer（通过 HTTP ），RPCServer（通过 gRPC ）。</li>
<li><a href="https://godoc.org/github.com/NYTimes/gizmo/server/kit">server/kit</a> - 基于 Go Kit 的实验包。</li>
<li><a href="https://godoc.org/github.com/NYTimes/gizmo/config">config</a> - 包含功能：解析 JSON 文件，Consul 键值对中的 JSON blob ，或者环境变量。</li>
<li><a href="https://godoc.org/github.com/NYTimes/gizmo/pubsub">pubsub</a> - 提供通用接口，用于从队列中发布和使用数据。</li>
<li><a href="https://godoc.org/github.com/NYTimes/gizmo/pubsub/pubsubtest">pubsub/pubsubtest</a> - 包含发布者和订阅者接口的测试实现。</li>
<li><a href="https://godoc.org/github.com/NYTimes/gizmo/web">web</a> - 公开用于从请求查询和有效负载中解析类型的函数。</li>
</ul>
<p>Pubsub 包提供了使用以下队列的接口：</p>
<ul>
<li><a href="https://godoc.org/github.com/NYTimes/gizmo/pubsub/aws">pubsub/aws</a> - 适用于 Amazon SNS/SQS。</li>
<li><a href="https://godoc.org/github.com/NYTimes/gizmo/pubsub/gcp">pubsub/gcp</a> - 适用于 Google Pubsub。</li>
<li><a href="https://godoc.org/github.com/NYTimes/gizmo/pubsub/kafka">pubsub/kafka</a> - 适用于 Kafka 主题。</li>
<li><a href="https://godoc.org/github.com/NYTimes/gizmo/pubsub/http">pubsub/http</a> - 用于通过 HTTP 发布。</li>
</ul>
<p>因此，在我看来，Gizmo 介于 Go Micro 和 Go Kit 之间。它不像 Go Micro 那样完全的“黑盒”。与此同时，它并不像 Go Kit 那么粗糙。它提供更高级别的构建组件，例如 config 和 pubsub 包。</p>
<h3 id="kite">Kite</h3>
<p>Kite 是一个在 Go 中开发微服务的框架。它公开了 RPC 客户端和服务端的包。
创建的服务会自动注册到服务发现系统 Kontrol 。Kontrol 是用 Kite 写的，它本身就是 Kite 服务。
这意味着 Kite 微服务在自己的环境中运行良好。如果您需要将 Kite 微服务连接到另一个服务发现系统，
则需要进行自定义。这是我从名单中删除 Kite 的主要原因，并决定不讨论这个框架。</p>
<h2 id="比较框架">比较框架</h2>
<p>我将使用四个类别比较框架：</p>
<ul>
<li>客观比较 - GitHub 统计</li>
<li>文档和示例</li>
<li>用户和社区</li>
<li>代码质量。</li>
</ul>
<h3 id="github-统计">GitHub 统计</h3>
<p>
        <img class="mx-auto" alt="表 1. Go 微服务框架统计（2018 年 4 月收集）" src="https://raw.githubusercontent.com/studygolang/gctt-images/master/microservices-in-go/MicroStatics.png" />   
    </p>
<h3 id="文档和示例">文档和示例</h3>
<p>简单来说，没有一个框架提供可靠的文档。通常，唯一的正式文档是 repo 首页上的 Readme 文件。</p>
<p>对于 Go Micro，可以在 <a href="https://micro.mu/">micro.mu</a>,<a href="https://medium.com/microhq">microhq</a> 和社交媒体 <a href="https://twitter.com/MicroHQ">@MicroHQ</a> 上获得大量信息和公告。</p>
<p>如果是 Go Kit，您可以在 <a href="https://peter.bourgon.org/go-kit/">Peter Bourgon</a> 的博客中找到最好的文档。我发现的一个最好的例子是在 <a href="http://www.ru-rocker.com/2017/04/17/micro-services-using-go-kit-service-discovery/">ru-rocker</a> 博客中。</p>
<p>使用 Gizmo，源代码提供了最好的文档和示例。</p>
<p>总而言之，如果你来自 NodeJS 世界，并希望看到类似 ExpressJS 的教程，你会感到失望。
另一方面，这是创建自己的教程的绝佳机会。</p>
<h3 id="用户和社区">用户和社区</h3>
<p>Go Kit 是最受欢迎的微服务框架，基于 GitHub 统计数据 - 在本出版物发布时超过 10k 星。它拥有大量的贡献者（122）和超过 1000 个分叉。
最后，Go Kit 由 <a href="https://www.digitalocean.com/">DigitalOcean</a> 提供支持。</p>
<p>Go Micro 第二，拥有超过 3600 颗 stars ，27 个贡献者和 385 个 forks 。Six Micro 的最大赞助商之一是 <a href="https://www.sixt.com/">Sixt</a>。
Gizmo 第三，超过 2200 颗 star, 31 个贡献者和 137 个 forks 。由纽约时报支持和创建。</p>
<h3 id="代码质量">代码质量</h3>
<ul>
<li>Go Kit 在代码质量类别中排名第一。它拥有近 80％ 的代码覆盖率和出色的 <a href="https://goreportcard.com/report/github.com/go-kit/kit">Go 报告评级</a>。</li>
<li>Gizmo 也有很好的 <a href="https://goreportcard.com/report/github.com/NYTimes/gizmo">Go 报告评级</a>。但它的代码覆盖率仅为 46％。</li>
<li>Go Micro 不提供覆盖率信息，但它确实具有很好的 <a href="https://goreportcard.com/report/github.com/micro/go-micro">Go 报告评级</a>。</li>
</ul>
<h2 id="微服务代码实践">微服务代码实践</h2>
<p>好吧，已有足够的理论。下边，为了更好地理解框架，我创建了三个简单的微服务。</p>
<p>
        <img class="mx-auto" alt="图 3. 实际示例架构" src="https://raw.githubusercontent.com/studygolang/gctt-images/master/microservices-in-go/micro_practice.png" />   
    </p>
<p>这些是实现一个业务功能的服务——&ldquo;Greeting&rdquo;。
当用户将 &ldquo;name&rdquo; 参数传递给服务器时，该服务会发送 Greeting 响应。此外，所有服务均符合以下要求：</p>
<ul>
<li>服务应自行注册服务发现系统。</li>
<li>服务应具有健康检查接口。</li>
<li>服务应至少支持 HTTP 和 gRPC 传输。</li>
</ul>
<p>对于那些喜欢阅读源代码的人。
您可以在此处阅读 repo 中的 <a href="https://github.com/antklim/go-microservices">源代码</a>.</p>
<h3 id="go-micro-greeter">Go Micro greeter</h3>
<p>使用 Go Micro 创建服务需要做的第一件事是定义 protobuf 描述。
方便后期，所有三项服务都采用了相同的 protobuf 定义。我创建了以下服务描述：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-proto" data-lang="proto"><span style="display:flex;"><span>syntax <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;proto3&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> pb;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">service</span> Greeter {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">rpc</span> Greeting(GreetingRequest) <span style="color:#66d9ef">returns</span> (GreetingResponse) {}<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">GreetingRequest</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> name <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">GreetingResponse</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> greeting <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>接口包含一种方法—— &ldquo;Greeting&rdquo;。
请求中有一个参数—— &rsquo;name&rsquo;，响应中有一个参数 - &lsquo;greeting&rsquo;。</p>
<p>然后我使用修改后的 <a href="https://github.com/micro/protoc-gen-micro">protoc 工具</a> 通过 protobuf 文件生成服务接口。
该生成器由 Go Micro fork 并进行了修改，以支持该框架的一些功能。
我在 “greeting” 服务中将这些连接在一起。此时，该服务正在启动并注册服务发现系统。
它只支持 gRPC 传输协议：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/go-micro-greeter/pb&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/micro/go-micro&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;golang.org/x/net/context&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Greeter 实现了 greeter 服务。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Greeter</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Greeting 方法实现。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">g</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Greeter</span>) <span style="color:#a6e22e">Greeting</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">GreetingRequest</span>, <span style="color:#a6e22e">out</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">GreetingResponse</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">Greeting</span> = <span style="color:#e6db74">&#34;GO-MICRO Hello &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">Name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">service</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">NewService</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">Name</span>(<span style="color:#e6db74">&#34;go-micro-srv-greeter&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">Version</span>(<span style="color:#e6db74">&#34;latest&#34;</span>),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">Init</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">RegisterGreeterHandler</span>(<span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">Server</span>(), new(<span style="color:#a6e22e">Greeter</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">Run</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>为了支持 HTTP 传输，我不得不添加其他模块。它将 HTTP 请求映射到 protobuf 定义的请求。并称为 gRPC 服务。
然后，它将服务响应映射到 HTTP 响应并将其回复给用户。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">proto</span> <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/go-micro-greeter/pb&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/micro/go-micro/client&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">web</span> <span style="color:#e6db74">&#34;github.com/micro/go-web&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">service</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">web</span>.<span style="color:#a6e22e">NewService</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">web</span>.<span style="color:#a6e22e">Name</span>(<span style="color:#e6db74">&#34;go-micro-web-greeter&#34;</span>),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/greeting&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Method</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;GET&#34;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">vars</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Query</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">names</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vars</span>[<span style="color:#e6db74">&#34;name&#34;</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">exists</span> <span style="color:#f92672">||</span> len(<span style="color:#a6e22e">names</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">name</span> = <span style="color:#a6e22e">names</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">cl</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">NewGreeterClient</span>(<span style="color:#e6db74">&#34;go-micro-srv-greeter&#34;</span>, <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">DefaultClient</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rsp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cl</span>.<span style="color:#a6e22e">Greeting</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">GreetingRequest</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>})
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>(), <span style="color:#ae81ff">500</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">js</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">rsp</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>(), <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Content-Type&#34;</span>, <span style="color:#e6db74">&#34;application/json&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">js</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">Init</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">Run</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>非常简单明了。 Go Micro 在幕后处理了许多事情——例如在服务发现系统中注册。
另一方面，创建纯 HTTP 服务很困难。</p>
<h3 id="go-kit-greeter">Go Kit greeter</h3>
<p>完成 Go Micro 后，我转到了 Go Kit 服务实现。
我花了很多时间阅读 Go Kit 存储库中提供的代码示例。
理解端点的概念花了我很多时间。下一个耗时的难题是服务发现注册商的代码。直到在找到一个 <a href="http://www.ru-rocker.com/2017/04/17/micro-services-using-go-kit-service-discovery/">不错的例子</a> 后我才实现它。</p>
<p>最后，我创建了四个包：</p>
<ul>
<li>服务逻辑实现。</li>
<li>与传输无关的服务端点。</li>
<li>传输特定端点 (gRPC,HTTP)</li>
<li>服务发现注册商。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">greeterservice</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Service 定义 greetings 服务接口。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Service</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Health</span>() <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Greeting</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GreeterService 实现 Service 接口。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">GreeterService</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Health 实现 Service 接口 Health 方法。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">GreeterService</span>) <span style="color:#a6e22e">Health</span>() <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Greeting 实现 Service 接口 Greeting 方法。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">GreeterService</span>) <span style="color:#a6e22e">Greeting</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">greeting</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">greeting</span> = <span style="color:#e6db74">&#34;GO-KIT Hello &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>如您所见，代码没有任何依赖关系。它只是实现逻辑。下一个代码段展示了端点定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">greeterendpoint</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/go-kit/kit/log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/go-kit-greeter/pkg/greeterservice&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/go-kit/kit/endpoint&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Endpoints 包含了所有组成 greeter 服务的端点。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 它被用作一个辅助结构，将所有端点收集到一个参数中。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Endpoints</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">HealthEndpoint</span>   <span style="color:#a6e22e">endpoint</span>.<span style="color:#a6e22e">Endpoint</span> <span style="color:#75715e">// used by Consul for the healthcheck
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">GreetingEndpoint</span> <span style="color:#a6e22e">endpoint</span>.<span style="color:#a6e22e">Endpoint</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// MakeServerEndpoints 返回服务端点，绑定在提供的中间件上。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">MakeServerEndpoints</span>(<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">greeterservice</span>.<span style="color:#a6e22e">Service</span>, <span style="color:#a6e22e">logger</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>) <span style="color:#a6e22e">Endpoints</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">healthEndpoint</span> <span style="color:#a6e22e">endpoint</span>.<span style="color:#a6e22e">Endpoint</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">healthEndpoint</span> = <span style="color:#a6e22e">MakeHealthEndpoint</span>(<span style="color:#a6e22e">s</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">healthEndpoint</span> = <span style="color:#a6e22e">LoggingMiddleware</span>(<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#e6db74">&#34;method&#34;</span>, <span style="color:#e6db74">&#34;Health&#34;</span>))(<span style="color:#a6e22e">healthEndpoint</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">greetingEndpoint</span> <span style="color:#a6e22e">endpoint</span>.<span style="color:#a6e22e">Endpoint</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">greetingEndpoint</span> = <span style="color:#a6e22e">MakeGreetingEndpoint</span>(<span style="color:#a6e22e">s</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">greetingEndpoint</span> = <span style="color:#a6e22e">LoggingMiddleware</span>(<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#e6db74">&#34;method&#34;</span>, <span style="color:#e6db74">&#34;Greeting&#34;</span>))(<span style="color:#a6e22e">greetingEndpoint</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Endpoints</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">HealthEndpoint</span>:   <span style="color:#a6e22e">healthEndpoint</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">GreetingEndpoint</span>: <span style="color:#a6e22e">greetingEndpoint</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// MakeHealthEndpoint 构造封装服务的 Health 端点。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">MakeHealthEndpoint</span>(<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">greeterservice</span>.<span style="color:#a6e22e">Service</span>) <span style="color:#a6e22e">endpoint</span>.<span style="color:#a6e22e">Endpoint</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">request</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">response</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">healthy</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Health</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">HealthResponse</span>{<span style="color:#a6e22e">Healthy</span>: <span style="color:#a6e22e">healthy</span>}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// MakeGreetingEndpoint 构造封装服务的 Greeter 端点。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">MakeGreetingEndpoint</span>(<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">greeterservice</span>.<span style="color:#a6e22e">Service</span>) <span style="color:#a6e22e">endpoint</span>.<span style="color:#a6e22e">Endpoint</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">request</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">response</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">request</span>.(<span style="color:#a6e22e">GreetingRequest</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">greeting</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Greeting</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">GreetingResponse</span>{<span style="color:#a6e22e">Greeting</span>: <span style="color:#a6e22e">greeting</span>}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Failer 是实现响应类型的接口。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 响应可以被检验，是否是 Failer 接口，如果是，那么就是失败的响应，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 而且，如果是，则根据错误使用单独的写路径对它们进行编码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Failer</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Failed</span>() <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// HealthRequest 包含了 Health 方法的所有请求参数。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HealthRequest</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// HealthResponse 包含了 Health 方法的响应值。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HealthResponse</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Healthy</span> <span style="color:#66d9ef">bool</span>  <span style="color:#e6db74">`json:&#34;healthy,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Err</span>     <span style="color:#66d9ef">error</span> <span style="color:#e6db74">`json:&#34;err,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Failed 实现 Failer 接口。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#a6e22e">HealthResponse</span>) <span style="color:#a6e22e">Failed</span>() <span style="color:#66d9ef">error</span> { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Err</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GreetingRequest 包含了 Greeting 方法的所有请求参数。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">GreetingRequest</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;name,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GreetingResponse 包含了 Greeting 方法的响应值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">GreetingResponse</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Greeting</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;greeting,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Err</span>      <span style="color:#66d9ef">error</span>  <span style="color:#e6db74">`json:&#34;err,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Failed 实现 Failer 接口。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#a6e22e">GreetingResponse</span>) <span style="color:#a6e22e">Failed</span>() <span style="color:#66d9ef">error</span> { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Err</span> }
</span></span></code></pre></div><p>在定义了服务和端点之后，我开始通过不同的传输协议公开端点。我从 HTTP 传输开始：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">greetertransport</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/go-kit-greeter/pkg/greeterendpoint&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/go-kit/kit/log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">httptransport</span> <span style="color:#e6db74">&#34;github.com/go-kit/kit/transport/http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/gorilla/mux&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ErrBadRouting 无效路径错误。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ErrBadRouting</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;inconsistent mapping between route and handler&#34;</span>)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NewHTTPHandler 返回一个 HTTP 处理程序（handler），该处理程序使一组端点在预定义的路径上可用。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewHTTPHandler</span>(<span style="color:#a6e22e">endpoints</span> <span style="color:#a6e22e">greeterendpoint</span>.<span style="color:#a6e22e">Endpoints</span>, <span style="color:#a6e22e">logger</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>) <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">NewRouter</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">options</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">httptransport</span>.<span style="color:#a6e22e">ServerOption</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">httptransport</span>.<span style="color:#a6e22e">ServerErrorEncoder</span>(<span style="color:#a6e22e">encodeError</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">httptransport</span>.<span style="color:#a6e22e">ServerErrorLogger</span>(<span style="color:#a6e22e">logger</span>),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// GET /health         查找服务健康信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// GET /greeting?name  查找 greeting
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Methods</span>(<span style="color:#e6db74">&#34;GET&#34;</span>).<span style="color:#a6e22e">Path</span>(<span style="color:#e6db74">&#34;/health&#34;</span>).<span style="color:#a6e22e">Handler</span>(<span style="color:#a6e22e">httptransport</span>.<span style="color:#a6e22e">NewServer</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">endpoints</span>.<span style="color:#a6e22e">HealthEndpoint</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">DecodeHTTPHealthRequest</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">EncodeHTTPGenericResponse</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">options</span><span style="color:#f92672">...</span>,
</span></span><span style="display:flex;"><span>    ))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Methods</span>(<span style="color:#e6db74">&#34;GET&#34;</span>).<span style="color:#a6e22e">Path</span>(<span style="color:#e6db74">&#34;/greeting&#34;</span>).<span style="color:#a6e22e">Handler</span>(<span style="color:#a6e22e">httptransport</span>.<span style="color:#a6e22e">NewServer</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">endpoints</span>.<span style="color:#a6e22e">GreetingEndpoint</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">DecodeHTTPGreetingRequest</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">EncodeHTTPGenericResponse</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">options</span><span style="color:#f92672">...</span>,
</span></span><span style="display:flex;"><span>    ))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// DecodeHTTPHealthRequest 方法。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DecodeHTTPHealthRequest</span>(<span style="color:#a6e22e">_</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">greeterendpoint</span>.<span style="color:#a6e22e">HealthRequest</span>{}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// DecodeHTTPGreetingRequest 方法。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DecodeHTTPGreetingRequest</span>(<span style="color:#a6e22e">_</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vars</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Query</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">names</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vars</span>[<span style="color:#e6db74">&#34;name&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">exists</span> <span style="color:#f92672">||</span> len(<span style="color:#a6e22e">names</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ErrBadRouting</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">greeterendpoint</span>.<span style="color:#a6e22e">GreetingRequest</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">names</span>[<span style="color:#ae81ff">0</span>]}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">req</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">encodeError</span>(<span style="color:#a6e22e">_</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>, <span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#a6e22e">err2code</span>(<span style="color:#a6e22e">err</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">NewEncoder</span>(<span style="color:#a6e22e">w</span>).<span style="color:#a6e22e">Encode</span>(<span style="color:#a6e22e">errorWrapper</span>{<span style="color:#a6e22e">Error</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">err2code</span>(<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">err</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">errorWrapper</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Error</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;error&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// EncodeHTTPGenericResponse is a transport/http.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// EncodeResponseFunc 返回 json 响应。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">EncodeHTTPGenericResponse</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">response</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">response</span>.(<span style="color:#a6e22e">greeterendpoint</span>.<span style="color:#a6e22e">Failer</span>); <span style="color:#a6e22e">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Failed</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">encodeError</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Failed</span>(), <span style="color:#a6e22e">w</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Content-Type&#34;</span>, <span style="color:#e6db74">&#34;application/json; charset=utf-8&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">NewEncoder</span>(<span style="color:#a6e22e">w</span>).<span style="color:#a6e22e">Encode</span>(<span style="color:#a6e22e">response</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在我开始 gRPC 端点实现之前，我不需要重新定义需要 protobuf.
我复制了 Go Micro 服务 protobuf 文件。但就 Go Kit 而言，我使用默认服务生成器来创建服务接口。</p>
<p>protobuf 定义的服务接口生成器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>protoc greeter.proto --go_out<span style="color:#f92672">=</span>plugins<span style="color:#f92672">=</span>grpc:.
</span></span></code></pre></div><p>Go Kit 服务 gRPC 端点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">greetertransport</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/go-kit-greeter/pb&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/go-kit-greeter/pkg/greeterendpoint&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/go-kit/kit/log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">grpctransport</span> <span style="color:#e6db74">&#34;github.com/go-kit/kit/transport/grpc&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">oldcontext</span> <span style="color:#e6db74">&#34;golang.org/x/net/context&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">grpcServer</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">greeter</span> <span style="color:#a6e22e">grpctransport</span>.<span style="color:#a6e22e">Handler</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NewGRPCServer 构建了 gRPC 可用的端点。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewGRPCServer</span>(<span style="color:#a6e22e">endpoints</span> <span style="color:#a6e22e">greeterendpoint</span>.<span style="color:#a6e22e">Endpoints</span>, <span style="color:#a6e22e">logger</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">GreeterServer</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">options</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">grpctransport</span>.<span style="color:#a6e22e">ServerOption</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">grpctransport</span>.<span style="color:#a6e22e">ServerErrorLogger</span>(<span style="color:#a6e22e">logger</span>),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">grpcServer</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">greeter</span>: <span style="color:#a6e22e">grpctransport</span>.<span style="color:#a6e22e">NewServer</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">endpoints</span>.<span style="color:#a6e22e">GreetingEndpoint</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">decodeGRPCGreetingRequest</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">encodeGRPCGreetingResponse</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">options</span><span style="color:#f92672">...</span>,
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Greeting 实现 GreeterService 接口 Greeting 方法。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">grpcServer</span>) <span style="color:#a6e22e">Greeting</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">oldcontext</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">GreetingRequest</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">GreetingResponse</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">greeter</span>.<span style="color:#a6e22e">ServeGRPC</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">GreetingResponse</span>), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// decodeGRPCGreetingRequest is a transport/grpc.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// DecodeRequestFunc 将 gRPC 请求转换为用户域的 greeting 请求。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">decodeGRPCGreetingRequest</span>(<span style="color:#a6e22e">_</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">grpcReq</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpcReq</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">GreetingRequest</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">greeterendpoint</span>.<span style="color:#a6e22e">GreetingRequest</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Name</span>}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// encodeGRPCGreetingResponse is a transport/grpc.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// DecodeRequestFunc 将 用户域的 greeting 转换为请求 gRPC 请求。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">encodeGRPCGreetingResponse</span>(<span style="color:#a6e22e">_</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">response</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">response</span>.(<span style="color:#a6e22e">greeterendpoint</span>.<span style="color:#a6e22e">GreetingResponse</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">GreetingResponse</span>{<span style="color:#a6e22e">Greeting</span>: <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Greeting</span>}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>最后，我实现了服务发现注册器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">greetersd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;math/rand&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/go-kit/kit/log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/go-kit/kit/sd&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">consulsd</span> <span style="color:#e6db74">&#34;github.com/go-kit/kit/sd/consul&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/hashicorp/consul/api&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ConsulRegister method.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ConsulRegister</span>(<span style="color:#a6e22e">consulAddress</span> <span style="color:#66d9ef">string</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">consulPort</span> <span style="color:#66d9ef">string</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">advertiseAddress</span> <span style="color:#66d9ef">string</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">advertisePort</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">registar</span> <span style="color:#a6e22e">sd</span>.<span style="color:#a6e22e">Registrar</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 日志 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">logger</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">logger</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">NewLogfmtLogger</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stderr</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">logger</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#e6db74">&#34;ts&#34;</span>, <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">DefaultTimestampUTC</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">logger</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#e6db74">&#34;caller&#34;</span>, <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">DefaultCaller</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Seed</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UTC</span>().<span style="color:#a6e22e">UnixNano</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 服务发现，我们使用 Consul.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">client</span> <span style="color:#a6e22e">consulsd</span>.<span style="color:#a6e22e">Client</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">consulConfig</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">DefaultConfig</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">consulConfig</span>.<span style="color:#a6e22e">Address</span> = <span style="color:#a6e22e">consulAddress</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">consulPort</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">consulClient</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">consulConfig</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;err&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">client</span> = <span style="color:#a6e22e">consulsd</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">consulClient</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">check</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">AgentServiceCheck</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">HTTP</span>:     <span style="color:#e6db74">&#34;http://&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">advertiseAddress</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">advertisePort</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/health&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Interval</span>: <span style="color:#e6db74">&#34;10s&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Timeout</span>:  <span style="color:#e6db74">&#34;1s&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Notes</span>:    <span style="color:#e6db74">&#34;Basic health checks&#34;</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">port</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">advertisePort</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">num</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">100</span>) <span style="color:#75715e">// 服务 ID 唯一
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">asr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">AgentServiceRegistration</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ID</span>:      <span style="color:#e6db74">&#34;go-kit-srv-greeter-&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">num</span>), 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Name</span>:    <span style="color:#e6db74">&#34;go-kit-srv-greeter&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Address</span>: <span style="color:#a6e22e">advertiseAddress</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Port</span>:    <span style="color:#a6e22e">port</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Tags</span>:    []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;go-kit&#34;</span>, <span style="color:#e6db74">&#34;greeter&#34;</span>},
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Check</span>:   <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">check</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">registar</span> = <span style="color:#a6e22e">consulsd</span>.<span style="color:#a6e22e">NewRegistrar</span>(<span style="color:#a6e22e">client</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">asr</span>, <span style="color:#a6e22e">logger</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在准备好所有构建块之后，我将它们连接在服务启动器中：</p>
<p>Go Kit 服务启动器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;os/signal&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;text/tabwriter&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/go-kit-greeter/pb&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/go-kit-greeter/pkg/greeterendpoint&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/go-kit-greeter/pkg/greetersd&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/go-kit-greeter/pkg/greeterservice&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/go-kit-greeter/pkg/greetertransport&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/go-kit/kit/log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/oklog/oklog/pkg/group&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">NewFlagSet</span>(<span style="color:#e6db74">&#34;greetersvc&#34;</span>, <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">ExitOnError</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">debugAddr</span>  = <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;debug.addr&#34;</span>, <span style="color:#e6db74">&#34;:9100&#34;</span>, <span style="color:#e6db74">&#34;Debug and metrics listen address&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">consulAddr</span> = <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;consul.addr&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;Consul Address&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">consulPort</span> = <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;consul.port&#34;</span>, <span style="color:#e6db74">&#34;8500&#34;</span>, <span style="color:#e6db74">&#34;Consul Port&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">httpAddr</span>   = <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;http.addr&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;HTTP Listen Address&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">httpPort</span>   = <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;http.port&#34;</span>, <span style="color:#e6db74">&#34;9110&#34;</span>, <span style="color:#e6db74">&#34;HTTP Listen Port&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">grpcAddr</span>   = <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;grpc-addr&#34;</span>, <span style="color:#e6db74">&#34;:9120&#34;</span>, <span style="color:#e6db74">&#34;gRPC listen address&#34;</span>)
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">Usage</span> = <span style="color:#a6e22e">usageFor</span>(<span style="color:#a6e22e">fs</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; [flags]&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">1</span>:])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">logger</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">logger</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">NewLogfmtLogger</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stderr</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">logger</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#e6db74">&#34;ts&#34;</span>, <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">DefaultTimestampUTC</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">logger</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#e6db74">&#34;caller&#34;</span>, <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">DefaultCaller</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">service</span> <span style="color:#a6e22e">greeterservice</span>.<span style="color:#a6e22e">Service</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">service</span> = <span style="color:#a6e22e">greeterservice</span>.<span style="color:#a6e22e">GreeterService</span>{}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">service</span> = <span style="color:#a6e22e">greeterservice</span>.<span style="color:#a6e22e">LoggingMiddleware</span>(<span style="color:#a6e22e">logger</span>)(<span style="color:#a6e22e">service</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">endpoints</span>   = <span style="color:#a6e22e">greeterendpoint</span>.<span style="color:#a6e22e">MakeServerEndpoints</span>(<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">logger</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">httpHandler</span> = <span style="color:#a6e22e">greetertransport</span>.<span style="color:#a6e22e">NewHTTPHandler</span>(<span style="color:#a6e22e">endpoints</span>, <span style="color:#a6e22e">logger</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">registar</span>    = <span style="color:#a6e22e">greetersd</span>.<span style="color:#a6e22e">ConsulRegister</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">consulAddr</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">consulPort</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">httpAddr</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">httpPort</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">grpcServer</span>  = <span style="color:#a6e22e">greetertransport</span>.<span style="color:#a6e22e">NewGRPCServer</span>(<span style="color:#a6e22e">endpoints</span>, <span style="color:#a6e22e">logger</span>)
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">g</span> <span style="color:#a6e22e">group</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 调试功能带 http.DefaultServeMux, 并提供 Go 调试和分析路由等功能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">debugListener</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">debugAddr</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;transport&#34;</span>, <span style="color:#e6db74">&#34;debug/HTTP&#34;</span>, <span style="color:#e6db74">&#34;during&#34;</span>, <span style="color:#e6db74">&#34;Listen&#34;</span>, <span style="color:#e6db74">&#34;err&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;transport&#34;</span>, <span style="color:#e6db74">&#34;debug/HTTP&#34;</span>, <span style="color:#e6db74">&#34;addr&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">debugAddr</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Serve</span>(<span style="color:#a6e22e">debugListener</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">DefaultServeMux</span>)
</span></span><span style="display:flex;"><span>        }, <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">debugListener</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 服务发现注册
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;transport&#34;</span>, <span style="color:#e6db74">&#34;HTTP&#34;</span>, <span style="color:#e6db74">&#34;addr&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">httpAddr</span>, <span style="color:#e6db74">&#34;port&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">httpPort</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">registar</span>.<span style="color:#a6e22e">Register</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:&#34;</span><span style="color:#f92672">+*</span><span style="color:#a6e22e">httpPort</span>, <span style="color:#a6e22e">httpHandler</span>)
</span></span><span style="display:flex;"><span>        }, <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">registar</span>.<span style="color:#a6e22e">Deregister</span>()
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// gRPC 加载我们创建的服务。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">grpcListener</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">grpcAddr</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;transport&#34;</span>, <span style="color:#e6db74">&#34;gRPC&#34;</span>, <span style="color:#e6db74">&#34;during&#34;</span>, <span style="color:#e6db74">&#34;Listen&#34;</span>, <span style="color:#e6db74">&#34;err&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;transport&#34;</span>, <span style="color:#e6db74">&#34;gRPC&#34;</span>, <span style="color:#e6db74">&#34;addr&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">grpcAddr</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">baseServer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">NewServer</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">RegisterGreeterServer</span>(<span style="color:#a6e22e">baseServer</span>, <span style="color:#a6e22e">grpcServer</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">baseServer</span>.<span style="color:#a6e22e">Serve</span>(<span style="color:#a6e22e">grpcListener</span>)
</span></span><span style="display:flex;"><span>        }, <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">grpcListener</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 监听 Ctrl+C 信号终止。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">cancelInterrupt</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{})
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Signal</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">signal</span>.<span style="color:#a6e22e">Notify</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGINT</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGTERM</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">sig</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">c</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;received signal %s&#34;</span>, <span style="color:#a6e22e">sig</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">cancelInterrupt</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }, <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>            close(<span style="color:#a6e22e">cancelInterrupt</span>)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;exit&#34;</span>, <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Run</span>())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">usageFor</span>(<span style="color:#a6e22e">fs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">FlagSet</span>, <span style="color:#a6e22e">short</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stderr</span>, <span style="color:#e6db74">&#34;USAGE\n&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stderr</span>, <span style="color:#e6db74">&#34;  %s\n&#34;</span>, <span style="color:#a6e22e">short</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stderr</span>, <span style="color:#e6db74">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stderr</span>, <span style="color:#e6db74">&#34;FLAGS\n&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">w</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tabwriter</span>.<span style="color:#a6e22e">NewWriter</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stderr</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39; &#39;</span>, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">VisitAll</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Flag</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;\t-%s %s\t%s\n&#34;</span>, <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">DefValue</span>, <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Usage</span>)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Flush</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stderr</span>, <span style="color:#e6db74">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>您可能已经注意到，我在几个地方使用了日志逻辑中间件。它允许我将记录逻辑与主服务/端点工作流分离。</p>
<p>服务级别日志记录中间件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">greeterservice</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/go-kit/kit/log&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ServiceMiddleware 定义了 service 中间件。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ServiceMiddleware</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">Service</span>) <span style="color:#a6e22e">Service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// LoggingMiddleware 使用 logger 作为依赖，返回一个 Service 中间件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">LoggingMiddleware</span>(<span style="color:#a6e22e">logger</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>) <span style="color:#a6e22e">ServiceMiddleware</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">next</span> <span style="color:#a6e22e">Service</span>) <span style="color:#a6e22e">Service</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">loggingMiddleware</span>{<span style="color:#a6e22e">next</span>, <span style="color:#a6e22e">logger</span>}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">loggingMiddleware</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Service</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">logger</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">loggingMiddleware</span>) <span style="color:#a6e22e">Health</span>() (<span style="color:#a6e22e">healthy</span> <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">begin</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Log</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;method&#34;</span>, <span style="color:#e6db74">&#34;Health&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;healthy&#34;</span>, <span style="color:#a6e22e">healthy</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;took&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">begin</span>),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    }(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">healthy</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Service</span>.<span style="color:#a6e22e">Health</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">loggingMiddleware</span>) <span style="color:#a6e22e">Greeting</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">greeting</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">begin</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Log</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;method&#34;</span>, <span style="color:#e6db74">&#34;Greeting&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>, <span style="color:#a6e22e">name</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;greeting&#34;</span>, <span style="color:#a6e22e">greeting</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;took&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">begin</span>),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    }(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">greeting</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Service</span>.<span style="color:#a6e22e">Greeting</span>(<span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>端点级别记录中间件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">greeterendpoint</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/go-kit/kit/endpoint&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/go-kit/kit/log&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// LoggingMiddleware 返回端点日志中间件，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 提供运行过程中日志信息，如果有错，提供错误信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">LoggingMiddleware</span>(<span style="color:#a6e22e">logger</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>) <span style="color:#a6e22e">endpoint</span>.<span style="color:#a6e22e">Middleware</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">next</span> <span style="color:#a6e22e">endpoint</span>.<span style="color:#a6e22e">Endpoint</span>) <span style="color:#a6e22e">endpoint</span>.<span style="color:#a6e22e">Endpoint</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">request</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">response</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">begin</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;transport_error&#34;</span>, <span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;took&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">begin</span>))
</span></span><span style="display:flex;"><span>            }(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">next</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">request</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="gizmo-greeter">Gizmo greeter</h3>
<p>我以与 Go Kit 类似的方式创建了 Gizmo 服务。我为服务，端点，传输和服务发现注册商定义了四个包。</p>
<p>服务实现和服务发现系统注册器与 Go Kit 服务共享相同的代码。但是端点定义和传输实现必须根据 Gizmo 功能完成。</p>
<p>Gizmo Greeting 端点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">greeterendpoint</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ocontext</span> <span style="color:#e6db74">&#34;golang.org/x/net/context&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/NYTimes/gizmo/server&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/gizmo-greeter/pkg/greeterservice&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Endpoints 包含所有组成 greeter 服务的端点
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Endpoints</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">HealthEndpoint</span>   <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">JSONContextEndpoint</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">GreetingEndpoint</span> <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">JSONContextEndpoint</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// MakeServerEndpoints 返回服务端点
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">MakeServerEndpoints</span>(<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">greeterservice</span>.<span style="color:#a6e22e">Service</span>) <span style="color:#a6e22e">Endpoints</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">healthEndpoint</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">MakeHealthEndpoint</span>(<span style="color:#a6e22e">s</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">greetingEndpoint</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">MakeGreetingEndpoint</span>(<span style="color:#a6e22e">s</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Endpoints</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">HealthEndpoint</span>:   <span style="color:#a6e22e">healthEndpoint</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">GreetingEndpoint</span>: <span style="color:#a6e22e">greetingEndpoint</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// MakeHealthEndpoint 构造 Health 端点。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">MakeHealthEndpoint</span>(<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">greeterservice</span>.<span style="color:#a6e22e">Service</span>) <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">JSONContextEndpoint</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">ocontext</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">healthy</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Health</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">HealthResponse</span>{<span style="color:#a6e22e">Healthy</span>: <span style="color:#a6e22e">healthy</span>}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// MakeGreetingEndpoint 构造 Greeting 端点。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">MakeGreetingEndpoint</span>(<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">greeterservice</span>.<span style="color:#a6e22e">Service</span>) <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">JSONContextEndpoint</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">ocontext</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">vars</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Query</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">names</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vars</span>[<span style="color:#e6db74">&#34;name&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">exists</span> <span style="color:#f92672">||</span> len(<span style="color:#a6e22e">names</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">errorResponse</span>{<span style="color:#a6e22e">Error</span>: <span style="color:#e6db74">&#34;query parameter &#39;name&#39; required&#34;</span>}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">greeting</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Greeting</span>(<span style="color:#a6e22e">names</span>[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">GreetingResponse</span>{<span style="color:#a6e22e">Greeting</span>: <span style="color:#a6e22e">greeting</span>}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// HealthRequest 包含了 Health 方法请求参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HealthRequest</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// HealthResponse 包含了 Health 方法响应值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HealthResponse</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Healthy</span> <span style="color:#66d9ef">bool</span> <span style="color:#e6db74">`json:&#34;healthy,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GreetingRequest 包含了 Greeting 方法请求参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">GreetingRequest</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;name,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GreetingResponse 包含了 Greeting 方法响应值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">GreetingResponse</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Greeting</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;greeting,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">errorResponse</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Error</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;error&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>如您所见，代码段与 Go Kit 类似。主要区别在于应该返回的接口类型：</p>
<p>GizmoGreeting HTTP 终端</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">greetertransport</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/NYTimes/gizmo/server&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/NYTimes/gziphandler&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/gizmo-greeter/pb&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/gizmo-greeter/pkg/greeterendpoint&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TService 会实现 server.RPCService （服务的 RPC），以及处理服务端请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">TService</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Endpoints</span> <span style="color:#a6e22e">greeterendpoint</span>.<span style="color:#a6e22e">Endpoints</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Config 包含 server 相关 json 配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Config</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Server</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Config</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NewTService 会使用给定的配置实例化 RPC 服务
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewTService</span>(<span style="color:#a6e22e">cfg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Config</span>, <span style="color:#a6e22e">endpoints</span> <span style="color:#a6e22e">greeterendpoint</span>.<span style="color:#a6e22e">Endpoints</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">TService</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">TService</span>{<span style="color:#a6e22e">Endpoints</span>: <span style="color:#a6e22e">endpoints</span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Prefix 返回所有端点服务使用的字符串前缀
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TService</span>) <span style="color:#a6e22e">Prefix</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Service 向 TService 提供要服务的服务描述和实现。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TService</span>) <span style="color:#a6e22e">Service</span>() (<span style="color:#f92672">*</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">ServiceDesc</span>, <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Greeter_serviceDesc</span>, <span style="color:#a6e22e">s</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Middleware 为所有请求挂载 http.Handler hook .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//在这个实现中，我们使用 GzipHandler 中间件来压缩我们的响应。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TService</span>) <span style="color:#a6e22e">Middleware</span>(<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gziphandler</span>.<span style="color:#a6e22e">GzipHandler</span>(<span style="color:#a6e22e">h</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ContextMiddleware 为所有请求挂载 server.ContextHAndler hook.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果需要修饰请求上下文，这将非常方便。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TService</span>) <span style="color:#a6e22e">ContextMiddleware</span>(<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">ContextHandler</span>) <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">ContextHandler</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// JSONMiddleware 为所有请求挂载 JSONEndpoint hooks.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//在这个实现中，我们使用它来提供应用程序日志记录，检查错误并提供通用响应。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TService</span>) <span style="color:#a6e22e">JSONMiddleware</span>(<span style="color:#a6e22e">j</span> <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">JSONContextEndpoint</span>) <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">JSONContextEndpoint</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">status</span>, <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">j</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">r</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">LogWithFields</span>(<span style="color:#a6e22e">r</span>).<span style="color:#a6e22e">WithFields</span>(<span style="color:#a6e22e">logrus</span>.<span style="color:#a6e22e">Fields</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>,
</span></span><span style="display:flex;"><span>            }).<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;problems with serving request&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusServiceUnavailable</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;sorry, this service is unavailable&#34;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">LogWithFields</span>(<span style="color:#a6e22e">r</span>).<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;success!&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">status</span>, <span style="color:#a6e22e">res</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ContextEndpoints 在你的服务是非 RPC 端点下，可以提供你需要的功能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 此时，我们不需要 RPC, 但是仍需要这个方法以实现 server.RPCService 接口。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TService</span>) <span style="color:#a6e22e">ContextEndpoints</span>() <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">ContextHandlerFunc</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">ContextHandlerFunc</span>{}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// JSONEndpoints 是 TService 中可用的所有端点的列表。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TService</span>) <span style="color:#a6e22e">JSONEndpoints</span>() <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">JSONContextEndpoint</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">JSONContextEndpoint</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;/health&#34;</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">JSONContextEndpoint</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;GET&#34;</span>: <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Endpoints</span>.<span style="color:#a6e22e">HealthEndpoint</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;/greeting&#34;</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">JSONContextEndpoint</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;GET&#34;</span>: <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Endpoints</span>.<span style="color:#a6e22e">GreetingEndpoint</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>GIzmo Greeting gRPC</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">greetertransport</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;github.com/antklim/go-microservices/gizmo-greeter/pb&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ocontext</span> <span style="color:#e6db74">&#34;golang.org/x/net/context&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Greeting 实现 gRPC 服务。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TService</span>) <span style="color:#a6e22e">Greeting</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">ocontext</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">GreetingRequest</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">GreetingResponse</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">GreetingResponse</span>{<span style="color:#a6e22e">Greeting</span>: <span style="color:#e6db74">&#34;Hola Gizmo RPC &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Name</span>}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Go Kit 和 Gizmo 之间的显着差异在于传输实现。 Gizmo 提供了几种可以使用的服务类型。
我所要做的就是将 HTTP 路径映射到端点定义。低级 HTTP 请求/响应处理由 Gizmo 处理。</p>
<h2 id="结论">结论</h2>
<p>Go Micro 是推出微服务系统的最快方式。框架提供了许多功能。所以你不需要重新发明轮子。
但这种舒适和速度伴随着牺牲 - 灵活性。它不像 Go Kit 那样容易改变或更新系统的各个部分。并且它强制 gRPC 作为首选的通信类型。</p>
<p>您可能需要一段时间才能熟悉 Go Kit。它需要熟悉 Golang 特性和软件架构方面的经验。
另一方面，没有框架限制。所有部件都可以独立更改和更新。
Gizmo 位于 Go Micro 和 Go Kit 之间。它提供了一些更高级别的抽象，例如 Service 包。
但缺乏文档和示例意味着我必须阅读源代码以了解不同的服务类型是如何工作的。使用 Gizmo 比使用 Go Kit 更容易。但它并不像 Go Micro 那么顺利。</p>
<p>这就是今天的一切。谢谢阅读。请查看微服务代码库以获取更多信息。如果您对 Go 和微服务框架有任何经验，请在下面的评论中分享。</p>
<p>&ndash;</p>
<p>via: <a href="https://medium.com/seek-blog/microservices-in-go-2fc1570f6800">https://medium.com/seek-blog/microservices-in-go-2fc1570f6800</a></p>
<p>作者：<a href="https://medium.com/@antklim">Anton Klimenko</a>
译者：<a href="https://github.com/TomatoAres">TomatoAres</a>
校对：<a href="https://github.com/magichan">magichan</a></p>
<p>本文由 <a href="https://github.com/studygolang/GCTT">GCTT</a> 原创编译，<a href="https://studygolang.com/">Go 中文网</a> 荣誉推出</p>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="https://tomatoares.github.io">战神西红柿</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="https://tomatoares.github.io/posts/go/translated/microservices-in-go/">https://tomatoares.github.io/posts/go/translated/microservices-in-go/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/archives/">归档</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/go'>go</a></li>
                
                <li><a href='/tags/microservice'>microservice</a></li>
                
            </ul>
            
        </div>
    </article>
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yourdiscussshortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "https://github.com/TomatoAres"
            issue-term="https://github.com/TomatoAres/TomatoAres.github.io/issues"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
    
    

</div>

                    <footer id="footer">
    <div>
        &copy; 2022 <a href="https://tomatoares.github.io">西红柿的博客 By 战神西红柿</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>
    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/douban.js'></script>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://tomatoares.github.io/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://tomatoares.github.io">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://tomatoares.github.io/posts/my-proust-questionnaire/" title="My Proust Questionnaire">My Proust Questionnaire</a>
    </li>
    
    <li>
        <a href="https://tomatoares.github.io/posts/storage/CSI-spec/" title="CSI - 容器存储接口">CSI - 容器存储接口</a>
    </li>
    
    <li>
        <a href="https://tomatoares.github.io/posts/cloud/kubelet-Q/" title="无法正常删除节点资源—— kubelet 问题排查">无法正常删除节点资源—— kubelet 问题排查</a>
    </li>
    
    <li>
        <a href="https://tomatoares.github.io/posts/cloud/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAIstio/" title="深入浅出 Istio [读书笔记]">深入浅出 Istio [读书笔记]</a>
    </li>
    
    <li>
        <a href="https://tomatoares.github.io/posts/storage/external-storage/" title="external-storage 探索">external-storage 探索</a>
    </li>
    
    <li>
        <a href="https://tomatoares.github.io/posts/leetcode/flag/" title="立个 flag ">立个 flag </a>
    </li>
    
    <li>
        <a href="https://tomatoares.github.io/posts/about/" title="About">About</a>
    </li>
    
    <li>
        <a href="https://tomatoares.github.io/posts/cloud/k8s/kind/" title="使用 kind 进行 e2e 测试">使用 kind 进行 e2e 测试</a>
    </li>
    
    <li>
        <a href="https://tomatoares.github.io/posts/cloud/k8s/cka/" title="cka 考试准备">cka 考试准备</a>
    </li>
    
    <li>
        <a href="https://tomatoares.github.io/posts/storage/ceph-rbd-resize/" title="kubernetes 1.12.6 storageclass 集成 ceph rbd resize 功能探索">kubernetes 1.12.6 storageclass 集成 ceph rbd resize 功能探索</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://tomatoares.github.io/categories/GCTT/">GCTT (15)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/go/">go (21)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/Istio/">Istio (1)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/Life/">Life (2)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/Network/">Network (8)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/Other/">Other (2)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/Storage/">Storage (11)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/Tool/">Tool (3)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/Web/">Web (10)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/docker/">docker (7)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/go/">go (4)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/k8s/">k8s (5)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/kubernetes/">kubernetes (1)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/linux/">linux (1)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/microservice/">microservice (4)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/Network/">Network (1)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/os/">os (1)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统 (2)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 (4)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构 (1)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/%E7%AE%97%E6%B3%95/">算法 (3)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/">组成原理 (1)</a></li>
    
    <li><a href="https://tomatoares.github.io/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/">虚拟化 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://tomatoares.github.io/tags/CSI/">CSI</a>
    
    <a href="https://tomatoares.github.io/tags/Ceph/">Ceph</a>
    
    <a href="https://tomatoares.github.io/tags/Cobra/">Cobra</a>
    
    <a href="https://tomatoares.github.io/tags/GC/">GC</a>
    
    <a href="https://tomatoares.github.io/tags/GCTT/">GCTT</a>
    
    <a href="https://tomatoares.github.io/tags/go/">go</a>
    
    <a href="https://tomatoares.github.io/tags/Http/">Http</a>
    
    <a href="https://tomatoares.github.io/tags/Http/">Http</a>
    
    <a href="https://tomatoares.github.io/tags/IO/">IO</a>
    
    <a href="https://tomatoares.github.io/tags/Istio/">Istio</a>
    
    <a href="https://tomatoares.github.io/tags/leetcode/">leetcode</a>
    
    <a href="https://tomatoares.github.io/tags/Linux/">Linux</a>
    
    <a href="https://tomatoares.github.io/tags/Network/">Network</a>
    
    <a href="https://tomatoares.github.io/tags/RPC/">RPC</a>
    
    <a href="https://tomatoares.github.io/tags/Storage/">Storage</a>
    
    <a href="https://tomatoares.github.io/tags/TCP/">TCP</a>
    
    <a href="https://tomatoares.github.io/tags/UDP/">UDP</a>
    
    <a href="https://tomatoares.github.io/tags/Unix/">Unix</a>
    
    <a href="https://tomatoares.github.io/tags/Web/">Web</a>
    
    <a href="https://tomatoares.github.io/tags/Websocket/">Websocket</a>
    
    <a href="https://tomatoares.github.io/tags/buffer/">buffer</a>
    
    <a href="https://tomatoares.github.io/tags/cache/">cache</a>
    
    <a href="https://tomatoares.github.io/tags/cka/">cka</a>
    
    <a href="https://tomatoares.github.io/tags/container/">container</a>
    
    <a href="https://tomatoares.github.io/tags/database/">database</a>
    
    <a href="https://tomatoares.github.io/tags/docker/">docker</a>
    
    <a href="https://tomatoares.github.io/tags/echo/">“echo”</a>
    
    <a href="https://tomatoares.github.io/tags/framework/">framework</a>
    
    <a href="https://tomatoares.github.io/tags/go/">go</a>
    
    <a href="https://tomatoares.github.io/tags/hugo/">hugo</a>
    
    <a href="https://tomatoares.github.io/tags/k8s/">k8s</a>
    
    <a href="https://tomatoares.github.io/tags/kind/">kind</a>
    
    <a href="https://tomatoares.github.io/tags/leetcode/">leetcode</a>
    
    <a href="https://tomatoares.github.io/tags/Linux/">Linux</a>
    
    <a href="https://tomatoares.github.io/tags/microservice/">microservice</a>
    
    <a href="https://tomatoares.github.io/tags/Network/">Network</a>
    
    <a href="https://tomatoares.github.io/tags/os/">os</a>
    
    <a href="https://tomatoares.github.io/tags/out-of-tree/">out-of-tree</a>
    
    <a href="https://tomatoares.github.io/tags/test/">test</a>
    
    <a href="https://tomatoares.github.io/tags/tool/">tool</a>
    
    <a href="https://tomatoares.github.io/tags/Web/">Web</a>
    
    <a href="https://tomatoares.github.io/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a>
    
    <a href="https://tomatoares.github.io/tags/%E5%9F%BA%E6%95%B0%E6%A0%91/">基数树</a>
    
    <a href="https://tomatoares.github.io/tags/%E5%B7%A5%E5%85%B7/">工具</a>
    
    <a href="https://tomatoares.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a>
    
    <a href="https://tomatoares.github.io/tags/%E7%AE%97%E6%B3%95/">算法</a>
    
    <a href="https://tomatoares.github.io/tags/%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/">组成原理</a>
    
    <a href="https://tomatoares.github.io/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/">虚拟化</a>
    
    <a href="https://tomatoares.github.io/tags/%E8%BF%90%E7%BB%B4/">运维</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://tomatoares.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>